!function(window,document){function getRecord(Counter,target){return new Promise(function(resolve,reject){Counter('get','/classes/Counter?where='+encodeURIComponent(JSON.stringify({target:target}))).then(resp=>resp.json()).then(({results,code,error})=>{if(401===code)throw error;results&&0<results.length?(code=results[0],resolve(code)):Counter('post','/classes/Counter',{target:target,time:0}).then(resp=>resp.json()).then((record,error)=>{if(error)throw error;resolve(record)}).catch(error=>{console.error('Failed to create: ',error),reject(error)})}).catch(error=>{console.error('LeanCloud Counter Error: ',error),reject(error)})})}function increment(Counter,incrArr){new Promise(function(resolve,reject){Counter('post','/batch',{requests:incrArr}).then(res=>{if((res=res.json()).error)throw res.error;resolve(res)}).catch(error=>{console.error('Failed to save visitor count: ',error),reject(error)})})}function buildIncrement(objectId){return{method:'PUT',path:'/1.1/classes/Counter/'+objectId,body:{time:{__op:'Increment',amount:1}}}}function validHost(){if(CONFIG.web_analytics.leancloud.ignore_local){var hostname=window.location.hostname;if('localhost'===hostname||'127.0.0.1'===hostname)return!1}return!0}function validUV(){var key='LeanCloud_UV_Flag',flag=localStorage.getItem(key);return!(flag&&(new Date).getTime()-parseInt(flag,10)<=864e5||(localStorage.setItem(key,(new Date).getTime().toString()),0))}function addCount(Counter){var enableIncr=CONFIG.web_analytics.enable&&!Fluid.ctx.dnt&&validHost(),getterArr=[],incrArr=[],pvCtn=document.querySelector('#leancloud-site-pv-container'),pvGetter,uvCtn=(pvCtn&&(pvGetter=getRecord(Counter,'site-pv').then(record=>{enableIncr&&incrArr.push(buildIncrement(record.objectId));var ele=document.querySelector('#leancloud-site-pv');ele&&(ele.innerText=(record.time||0)+(enableIncr?1:0),pvCtn.style.display='inline')}),getterArr.push(pvGetter)),document.querySelector('#leancloud-site-uv-container')),uvGetter,viewCtn=(uvCtn&&(uvGetter=getRecord(Counter,'site-uv').then(record=>{var incrUV=validUV()&&enableIncr,ele=(incrUV&&incrArr.push(buildIncrement(record.objectId)),document.querySelector('#leancloud-site-uv'));ele&&(ele.innerText=(record.time||0)+(incrUV?1:0),uvCtn.style.display='inline')}),getterArr.push(uvGetter)),document.querySelector('#leancloud-page-views-container')),path,target,viewGetter;viewCtn&&(path=eval(CONFIG.web_analytics.leancloud.path||'window.location.pathname'),target=decodeURI(path.replace(/\/*(index.html)?$/,'/')),viewGetter=getRecord(Counter,target).then(record=>{enableIncr&&incrArr.push(buildIncrement(record.objectId));var ele=document.querySelector('#leancloud-page-views');ele&&(ele.innerText=(record.time||0)+(enableIncr?1:0),viewCtn.style.display='inline')}),getterArr.push(viewGetter)),enableIncr&&Promise.all(getterArr).then(()=>{0<incrArr.length&&increment(Counter,incrArr)})}var appId=CONFIG.web_analytics.leancloud.app_id,appKey=CONFIG.web_analytics.leancloud.app_key,serverUrl=CONFIG.web_analytics.leancloud.server_url;if(!appId)throw new Error('LeanCloud appId is empty');if(!appKey)throw new Error('LeanCloud appKey is empty');function fetchData(api_server){addCount((method,url,data)=>fetch(api_server+'/1.1'+url,{method:method,headers:{'X-LC-Id':appId,'X-LC-Key':appKey,'Content-Type':'application/json'},body:JSON.stringify(data)}))}var apiServer=serverUrl||`https://${appId.slice(0,8).toLowerCase()}.api.lncldglobal.com`;apiServer?fetchData(apiServer):fetch('https://app-router.leancloud.cn/2/route?appId='+appId).then(resp=>resp.json()).then(data=>{data.api_server&&fetchData('https://'+data.api_server)})}(window,document);